<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />


<meta name="date" content="2020-07-27" />

<title>Getting Started with Capture Hi-C Analysis Engine</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>



<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Getting Started with Capture Hi-C Analysis Engine</h1>
<h4 class="date">2020-07-27</h4>


<div id="TOC">
<ul>
<li><a href="#quickstart">Quickstart</a></li>
<li><a href="#preprocessing">Pre-Processing Data</a></li>
<li><a href="#statistical-model">Statistical Model</a><ul>
<li><a href="#distribution-of-the-counts">Distribution of the Counts</a><ul>
<li><a href="#negative-binomial">Negative Binomial</a></li>
<li><a href="#poisson">Poisson</a></li>
<li><a href="#truncated-negative-binomial">Truncated Negative Binomial</a></li>
<li><a href="#truncated-poisson">Truncated Poisson</a></li>
</ul></li>
<li><a href="#adjusting-for-covariates">Adjusting for Covariates</a></li>
<li><a href="#filtering-baits-and-targets">Filtering Baits and Targets</a></li>
<li><a href="#multiple-testing-correction">Multiple Testing Correction</a></li>
<li><a href="#merging-biological-replicates">Merging Biological Replicates</a></li>
<li><a href="#adjusting-for-custom-covariates">Adjusting for Custom Covariates</a></li>
</ul></li>
<li><a href="#session-info">Session Info</a></li>
<li><a href="#acknowledgements">Acknowledgements</a></li>
<li><a href="#references">References</a></li>
</ul>
</div>

<div id="quickstart" class="section level1">
<h1>Quickstart</h1>
<p>The main function for running the CHiCANE method is <code>chicane()</code>. This takes a bam file and bed files with all restriction fragments and targeted restriction fragments as input, and produces a table with fragment interactions and associated p-values.</p>
<p>The package comes with a subset of reads from a capture Hi-C experiment on the Bre80 normal epithelial breast tissue cell line <span class="citation">(Baxter et al. 2018)</span>. The experiment targeted several breast cancer risk loci in non-coding regions of the genome, and aimed to associate these risk variants with genes. Two of the risk SNPs are rs13387042 and rs16857609, and reads that map to them have been included in the file Bre80_2q35.bam.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1"></a><span class="kw">library</span>(chicane);</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="co">#&gt; Loading required package: gamlss.tr</span></span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="co">#&gt; Loading required package: gamlss.dist</span></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="co">#&gt; Loading required package: MASS</span></span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="co">#&gt; Loading required package: gamlss</span></span>
<span id="cb1-6"><a href="#cb1-6"></a><span class="co">#&gt; Loading required package: splines</span></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="co">#&gt; Loading required package: gamlss.data</span></span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="co">#&gt; </span></span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="co">#&gt; Attaching package: &#39;gamlss.data&#39;</span></span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="co">#&gt; The following object is masked from &#39;package:datasets&#39;:</span></span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="co">#&gt; </span></span>
<span id="cb1-12"><a href="#cb1-12"></a><span class="co">#&gt;     sleep</span></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="co">#&gt; Loading required package: nlme</span></span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="co">#&gt; Loading required package: parallel</span></span>
<span id="cb1-15"><a href="#cb1-15"></a><span class="co">#&gt;  **********   GAMLSS Version 5.1-6  **********</span></span>
<span id="cb1-16"><a href="#cb1-16"></a><span class="co">#&gt; For more on GAMLSS look at http://www.gamlss.org/</span></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="co">#&gt; Type gamlssNews() to see new features/changes/bug fixes.</span></span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="co">#&gt; Loading required package: data.table</span></span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="co"># example BAM file, baits, and restriction fragments</span></span>
<span id="cb1-21"><a href="#cb1-21"></a>bam &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&#39;extdata&#39;</span>, <span class="st">&#39;Bre80_2q35.bam&#39;</span>, <span class="dt">package =</span> <span class="st">&#39;chicane&#39;</span>);</span>
<span id="cb1-22"><a href="#cb1-22"></a>baits &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&#39;extdata&#39;</span>, <span class="st">&#39;2q35.bed&#39;</span>, <span class="dt">package =</span> <span class="st">&#39;chicane&#39;</span>);</span>
<span id="cb1-23"><a href="#cb1-23"></a>fragments &lt;-<span class="st"> </span><span class="kw">system.file</span>(<span class="st">&#39;extdata&#39;</span>, <span class="st">&#39;GRCh38_HindIII_chr2.bed.gz&#39;</span>, <span class="dt">package =</span> <span class="st">&#39;chicane&#39;</span>); <span class="co"># HindIII fragments on chromosome 2</span></span>
<span id="cb1-24"><a href="#cb1-24"></a></span>
<span id="cb1-25"><a href="#cb1-25"></a><span class="cf">if</span>( <span class="kw">bedtools.installed</span>() ) {</span>
<span id="cb1-26"><a href="#cb1-26"></a>  chicane.results &lt;-<span class="st"> </span><span class="kw">chicane</span>(</span>
<span id="cb1-27"><a href="#cb1-27"></a>    <span class="dt">bam =</span> bam,</span>
<span id="cb1-28"><a href="#cb1-28"></a>    <span class="dt">baits =</span> baits,</span>
<span id="cb1-29"><a href="#cb1-29"></a>    <span class="dt">fragments =</span> fragments</span>
<span id="cb1-30"><a href="#cb1-30"></a>    );</span>
<span id="cb1-31"><a href="#cb1-31"></a></span>
<span id="cb1-32"><a href="#cb1-32"></a>    <span class="kw">print</span>( chicane.results[ <span class="dv">1</span><span class="op">:</span><span class="dv">10</span> ] );</span>
<span id="cb1-33"><a href="#cb1-33"></a>}</span></code></pre></div>
<p>The <code>chicane</code> function returns a <code>data.table</code> object sorted by q-value. Each row contains information about the target and bait fragments, and the observed and expected number of reads linking the two fragments.</p>
</div>
<div id="preprocessing" class="section level1">
<h1>Pre-Processing Data</h1>
<p>The <code>chicane</code> function can operate directly on BAM files. To convert the BAM file into a text file, R calls the shell script <code>prepare_bam.sh</code>. This script relies on <a href="http://bedtools.readthedocs.io/en/latest/index.html">bedtools</a> to select reads overlapping the captured fragments and identify the restriction fragments corresponding to each read. The resulting data is read into a <a href="https://CRAN.R-project.org/package=data.table"><code>data.table</code></a> object, and the number of reads linking any two fragments is calculated.</p>
<p>For users that have a digested genome output from HiCUP, this needs to be converted to BED format to be compatible with bedtools. CHiCANE includes a helper function, <code>convert.hicup.digest.bed()</code>, which can be used to convert a digested genome in HiCUP format to a BED file of the restiction digest fragments.</p>
<p>This processing can take a while (~45 minutes for a 19GB BAM file on a commodity computer with 13GB RAM), and only needs to be done once for each BAM. To speed up model fitting, it is possible to pre-process the data with the <code>prepare.data()</code> function and run <code>chicane</code> directly on the resulting data table.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1"></a><span class="cf">if</span>( <span class="kw">bedtools.installed</span>() ) {</span>
<span id="cb2-2"><a href="#cb2-2"></a>  interaction.data &lt;-<span class="st"> </span><span class="kw">prepare.data</span>(</span>
<span id="cb2-3"><a href="#cb2-3"></a>    <span class="dt">bam =</span> bam,</span>
<span id="cb2-4"><a href="#cb2-4"></a>    <span class="dt">baits =</span> baits,</span>
<span id="cb2-5"><a href="#cb2-5"></a>    <span class="dt">fragments =</span> fragments</span>
<span id="cb2-6"><a href="#cb2-6"></a>    );</span>
<span id="cb2-7"><a href="#cb2-7"></a>}</span></code></pre></div>
<p>The interaction data object contains details of the fragments, and the number of reads linking the two fragments.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1"></a><span class="cf">if</span>( <span class="kw">bedtools.installed</span>() ) <span class="kw">print</span>(interaction.data);</span></code></pre></div>
<p>By default, only combinations of fragments that are detected at least once are included in the data. To also include zero counts, use the <code>include.zeros</code> argument. Setting <code>include.zeros = &#39;cis&#39;</code> includes all zero counts for bait/ target combinations on the same chromosome, while <code>include.zeros = &#39;all&#39;</code> includes all possible combinations.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1"></a><span class="cf">if</span>( <span class="kw">bedtools.installed</span>() ) {</span>
<span id="cb4-2"><a href="#cb4-2"></a>  cis.zero.results &lt;-<span class="st"> </span><span class="kw">chicane</span>(</span>
<span id="cb4-3"><a href="#cb4-3"></a>    <span class="dt">bam =</span> bam,</span>
<span id="cb4-4"><a href="#cb4-4"></a>    <span class="dt">baits =</span> baits,</span>
<span id="cb4-5"><a href="#cb4-5"></a>    <span class="dt">fragments =</span> fragments,</span>
<span id="cb4-6"><a href="#cb4-6"></a>    <span class="dt">include.zeros =</span> <span class="st">&#39;cis&#39;</span></span>
<span id="cb4-7"><a href="#cb4-7"></a>    ); </span>
<span id="cb4-8"><a href="#cb4-8"></a></span>
<span id="cb4-9"><a href="#cb4-9"></a>    <span class="kw">print</span>( cis.zero.results[ <span class="dv">1</span><span class="op">:</span><span class="dv">10</span> ] );</span>
<span id="cb4-10"><a href="#cb4-10"></a>}</span></code></pre></div>
<p>For most experiments including zeros will result in impractically large files. Another option for accounting for zero counts is to specify a truncated distribution through the <code>distribution</code> argument. However, this will slow down model fitting.</p>
<p>The <code>interactions</code> argument of the <code>chicane()</code> function can take either a <code>data.table</code> object from <code>prepare.data</code> or the path to such a table.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1"></a><span class="cf">if</span>( <span class="kw">bedtools.installed</span>() ) {</span>
<span id="cb5-2"><a href="#cb5-2"></a>  file.name &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="st">&#39;interaction_data&#39;</span>);</span>
<span id="cb5-3"><a href="#cb5-3"></a>  <span class="kw">write.table</span>(interaction.data, file.name, <span class="dt">row.names =</span> <span class="ot">FALSE</span>);</span>
<span id="cb5-4"><a href="#cb5-4"></a></span>
<span id="cb5-5"><a href="#cb5-5"></a>  chicane.results &lt;-<span class="st"> </span><span class="kw">chicane</span>(<span class="dt">interactions =</span> file.name); </span>
<span id="cb5-6"><a href="#cb5-6"></a>}</span></code></pre></div>
</div>
<div id="statistical-model" class="section level1">
<h1>Statistical Model</h1>
<p>The CHiCANE method models the expected number of reads linking two restriction fragments as a function of the distance between the loci and the “interactibility” of the bait fragment, that is, its inherent propensity to interact with other fragments.</p>
<p>Let <span class="math inline">\(Y_{ij}\)</span> denote the number of reads linking bait <span class="math inline">\(i\)</span> and target fragment <span class="math inline">\(j\)</span>, <span class="math inline">\(d_{ij}\)</span> be the distance between the two fragments, and <span class="math inline">\(t_i\)</span> denote the number of reads linking the bait <span class="math inline">\(i\)</span> with another fragment in trans. The CHiCANE model assumes that <span class="math inline">\(Y_{ij}\)</span> follows a distribution with mean parameter <span class="math inline">\(\mu_{ij}\)</span>, where</p>
<p><span class="math display">\[\begin{equation}
    \mu_{ij} = \beta_0 + \beta_1\log(d_{ij}) + \beta_2\log(t_i + 1)
\end{equation}\]</span></p>
<p>If the other end fragment <span class="math inline">\(j\)</span> is also a bait, terms are included to adjust for the trans counts of the fragment <span class="math inline">\(j\)</span>, as well as the product of the trans counts of the two fragments as shown below</p>
<p><span class="math display">\[\begin{equation}
    \mu_{ij} = \beta_0 + \beta_1\log(d_{ij}) + \beta_2\log(t_i + 1) + \beta_3\log(t_j + 1) + \beta_4\log(t_i + 1)\log(t_j + 1)
\end{equation}\]</span></p>
<p>Once an expected value <span class="math inline">\(\mu_{ij}\)</span> is obtained for each combination of fragments, a <span class="math inline">\(p\)</span>-value for the observed counts <span class="math inline">\(y_{ij}\)</span> exceeding what’s expected by random chance is calculated as</p>
<p><span class="math display">\[\begin{equation}
p = P(Y_{ij} \geq y_{ij})
\end{equation}\]</span></p>
<p>The probability <span class="math inline">\(P(Y_{ij} \geq y_{ij})\)</span> depends on how the distribution <span class="math inline">\(Y_{ij} \mid \mu_{ij}\)</span> of the counts conditional on the expected value is modelled.</p>
<div id="distribution-of-the-counts" class="section level2">
<h2>Distribution of the Counts</h2>
<p>The CHiCANE method supports several different distributions of the counts <span class="math inline">\(Y_{ij}\)</span> conditional on the mean <span class="math inline">\(\mu_{ij}\)</span>. By default the counts are assumed to follow a negative binomial distribution with <span class="math inline">\(E(Y_{ij}) = exp (\mu_{ij})\)</span>. The negative binomial is similar to the Poisson model for counts, but includes an overdispersion term that makes it more appropriate for datasets with high variance. After fitting <span class="math inline">\(\beta_0, \beta_1, \beta_2\)</span> and the overdispersion term by a maximum likelihood over all pairs of fragments, we use the fitted model to estimate a <span class="math inline">\(p\)</span>-value for each pair. The Poisson, truncated Poisson, or truncated negative binomial distribution can be specified through the <code>distribution</code> argument.</p>
<div id="negative-binomial" class="section level3">
<h3>Negative Binomial</h3>
<p>The negative binomial distribution models the counts as <span class="math inline">\(Y \sim NB(\mu, \theta)\)</span>, where <span class="math inline">\(\mu\)</span> is the mean and <span class="math inline">\(\theta\)</span> is a dispersion parameter. Under this model, the variance of the counts conditional on the mean <span class="math inline">\(\mu\)</span> is given by</p>
<p><span class="math display">\[\begin{equation}
Var(Y) = \mu + \frac{\mu^2}{\theta}
\end{equation}\]</span></p>
<p>The model is fit using the <code>glm.nb()</code> function in the MASS package. The maximum likelihood estimates (MLEs) of the coefficients <span class="math inline">\(\hat{\beta_i}\)</span> are used to provide an estimate of the expected number of counts for each combination of restriction fragments. The MLE of the dispersion parameter <span class="math inline">\(\theta\)</span> is used as the dispersion parameter (<code>size</code>) in the negative binomial model.</p>
<p>Occasionally, the model fitting procedure will result in numerical errors as the result of lack of convergence. This is most often due to lack of overdispersion in the data leading to an unstable estimate of <span class="math inline">\(\theta\)</span>. If the variance is approximately equal to the mean, the <span class="math inline">\(\theta\)</span> term goes to infinity and the model fails to converge.</p>
<p>When the model throws a numerical warning or fails to converge, the <code>chicane()</code> function will attempt to diagnose if the problem was due to lack of overdispersion. This is done by fitting a negative binomial regression model with 25 iterations, and using the resulting fitted values and dispersion parameter to examine the variance of the negative binomial. If the estimated variance at the point with the largest fitted value is less than 0.1% greater than the corresponding estimate of the Poisson variance (i.e. the fitted value at that point), a Poisson distribution is fit instead.</p>
</div>
<div id="poisson" class="section level3">
<h3>Poisson</h3>
<p>Unlike the negative binomial, the Poisson distribution does not allow for the variance of the counts to exceed their mean. This model assumes that <span class="math inline">\(Y \sim \text{Poisson}(\mu)\)</span>, giving <span class="math inline">\(Var(Y) = \mu\)</span>. In practice, capture Hi-C counts often show more variability than can be explained by the Poisson model, leading to false positive interaction calls.</p>
</div>
<div id="truncated-negative-binomial" class="section level3">
<h3>Truncated Negative Binomial</h3>
<p>When fitting the model without including unobserved combinations of fragments (see <a href="#preprocessing">Pre-processing Data</a>), there are no counts of zero in the data. To accommodate this in the statistical model, a truncated Poisson distribution can be fit using the <a href="https://cran.r-project.org/package=gamlss.tr">GAMLSS package</a> <span class="citation">(Stasinopoulos and Rigby 2016)</span>. This model assigns <span class="math inline">\(P(Y = 0) = 0\)</span>, and assumes the probabilities are proportional to the negative binomial probabilities for values <span class="math inline">\(y &gt; 0\)</span>.</p>
</div>
<div id="truncated-poisson" class="section level3">
<h3>Truncated Poisson</h3>
<p>Similarly to the truncated negative binomial, the truncated Poisson distribution is supported by setting <code>distribution = &#39;truncated-poisson&#39;</code>. This model assumes the probabilities are proportional to the Poisson probabilities for values <span class="math inline">\(y&gt;0\)</span>.</p>
</div>
</div>
<div id="adjusting-for-covariates" class="section level2">
<h2>Adjusting for Covariates</h2>
<p>Adjusting for distance is done in a piecewise linear fashion. Cis-data is ordered by distance, and split into equally sized bins. The count model is then fit separately within each bin, and results are merged at the end by concatenating the results from the individual model fits.</p>
<p>By default, CHiCANE tries to split the data based on distance quantiles, i.e. into 100 equally sized groups. In some cases, particularly when dealing with smaller datasets, the resulting datasets are too small for model fitting. When this occurs, the number of distance bins are halved until all resulting datasets are large enough for the model to be fit. To override the default behaviour, pass the desired number of distance bins to <code>distance.bins</code>. For example, setting <code>distance.bins = 4</code> results in the count model being fit separately in each quartile. Trans interactions are fit separately from cis interactions.</p>
</div>
<div id="filtering-baits-and-targets" class="section level2">
<h2>Filtering Baits and Targets</h2>
<p>By default, all baits and targets are included when fitting the CHiCANE model. An alternative approach is to filter out baits and fragments with low <span class="citation">(Dryden et al. 2014)</span> or high <span class="citation">(Cairns et al. 2016)</span> degree of “interactibility”, as inferred through the trans counts. CHiCANE also supports this model through the <code>bait.filters</code> and <code>target.filters</code> arguments.</p>
<p>Each of these take a vector of length two, where each element corresponds to the proportion of fragments that should be considered to fall below the “lower limit” and “upper limit.” For example, passing in <code>bait.filters = c(0.3, 0.9)</code> means that the baits with the lowest 30% or highest 10% of trans counts will be removed before fitting the model.</p>
<p>Filtering fragments may affect multiple testing correction by changing the number of tests performed.</p>
</div>
<div id="multiple-testing-correction" class="section level2">
<h2>Multiple Testing Correction</h2>
<p>By default, CHiCANE performs multiple testing correction separately for each bait. To change this to a global multiple testing correction, set <code>multiple.testing.correction = &#39;global&#39;</code> in the main <code>chicane()</code> function.</p>
</div>
<div id="merging-biological-replicates" class="section level2">
<h2>Merging Biological Replicates</h2>
<p>CHiCANE can merge replicates at the data processing step. If more than one BAM file is available, these can be passed as vector to the <code>bam</code> argument of the <code>chicane()</code> and <code>prepare.data()</code> functions. The <code>replicate.merging.method</code> determines how replicates are merged. Available options are ‘sum’ and ‘weighted-sum’.</p>
</div>
<div id="adjusting-for-custom-covariates" class="section level2">
<h2>Adjusting for Custom Covariates</h2>
<p>CHiCANE allows users to specify additional covariates that should be added to the model with the <code>adjustment.terms</code> argument. For example, we can add a term to adjust for the chromosome of the target fragment.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1"></a><span class="kw">data</span>(bre80);</span>
<span id="cb6-2"><a href="#cb6-2"></a>adjusted.results &lt;-<span class="st"> </span><span class="kw">chicane</span>(</span>
<span id="cb6-3"><a href="#cb6-3"></a>  <span class="dt">interactions =</span> bre80, </span>
<span id="cb6-4"><a href="#cb6-4"></a>  <span class="dt">adjustment.terms =</span> <span class="st">&#39;target.chr&#39;</span></span>
<span id="cb6-5"><a href="#cb6-5"></a>  );</span>
<span id="cb6-6"><a href="#cb6-6"></a></span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="kw">print</span>( adjusted.results[ <span class="dv">1</span><span class="op">:</span><span class="dv">5</span> ] );</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="co">#&gt;                   target.id                  bait.id target.chr target.start</span></span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="co">#&gt; 1:    chr19:1155128-1228414 chr2:217035649-217042355      chr19      1155128</span></span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="co">#&gt; 2: chr1:117125276-117135137 chr2:217035649-217042355       chr1    117125276</span></span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="co">#&gt; 3:   chr1:14950583-14951791 chr2:217035649-217042355       chr1     14950583</span></span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="co">#&gt; 4:   chr1:49076960-49080684 chr2:217035649-217042355       chr1     49076960</span></span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="co">#&gt; 5: chr3:145680459-145682483 chr2:217035649-217042355       chr3    145680459</span></span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="co">#&gt;    target.end bait.chr bait.start  bait.end bait.to.bait bait.trans.count</span></span>
<span id="cb6-15"><a href="#cb6-15"></a><span class="co">#&gt; 1:    1228414     chr2  217035649 217042355        FALSE             9494</span></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co">#&gt; 2:  117135137     chr2  217035649 217042355        FALSE             9494</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="co">#&gt; 3:   14951791     chr2  217035649 217042355        FALSE             9494</span></span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="co">#&gt; 4:   49080684     chr2  217035649 217042355        FALSE             9494</span></span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="co">#&gt; 5:  145682483     chr2  217035649 217042355        FALSE             9494</span></span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="co">#&gt;    target.trans.count distance count expected   p.value   q.value</span></span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="co">#&gt; 1:                  2       NA     2 1.003963 0.2656989 0.6417435</span></span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="co">#&gt; 2:                  2       NA     2 1.003992 0.2657096 0.6417435</span></span>
<span id="cb6-23"><a href="#cb6-23"></a><span class="co">#&gt; 3:                  2       NA     2 1.003992 0.2657096 0.6417435</span></span>
<span id="cb6-24"><a href="#cb6-24"></a><span class="co">#&gt; 4:                  2       NA     2 1.003992 0.2657096 0.6417435</span></span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="co">#&gt; 5:                  2       NA     2 1.004014 0.2657179 0.6417435</span></span></code></pre></div>
<p>The <code>adjustment.terms</code> argument also supports more complex expressions such as log-transformations. Multiple adjustment terms can be added by passing a vector.</p>
<p>Any adjustment term must correspond to a column already present in the data. If you would like to adjust for anything that is not already present in the CHiCANE output (e.g. GC content), there’s a three step approach:</p>
<ol style="list-style-type: decimal">
<li>Run <code>prepare.data()</code> on your BAM file</li>
<li>Add extra columns to the resulting data frame</li>
<li>Run <code>chicane()</code> with the <code>interactions</code> argument</li>
</ol>
</div>
</div>
<div id="session-info" class="section level1">
<h1>Session Info</h1>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1"></a><span class="kw">sessionInfo</span>();</span>
<span id="cb7-2"><a href="#cb7-2"></a><span class="co">#&gt; R version 3.6.1 (2019-07-05)</span></span>
<span id="cb7-3"><a href="#cb7-3"></a><span class="co">#&gt; Platform: x86_64-apple-darwin15.6.0 (64-bit)</span></span>
<span id="cb7-4"><a href="#cb7-4"></a><span class="co">#&gt; Running under: macOS Sierra 10.12.6</span></span>
<span id="cb7-5"><a href="#cb7-5"></a><span class="co">#&gt; </span></span>
<span id="cb7-6"><a href="#cb7-6"></a><span class="co">#&gt; Matrix products: default</span></span>
<span id="cb7-7"><a href="#cb7-7"></a><span class="co">#&gt; BLAS:   /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRblas.0.dylib</span></span>
<span id="cb7-8"><a href="#cb7-8"></a><span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/3.6/Resources/lib/libRlapack.dylib</span></span>
<span id="cb7-9"><a href="#cb7-9"></a><span class="co">#&gt; </span></span>
<span id="cb7-10"><a href="#cb7-10"></a><span class="co">#&gt; locale:</span></span>
<span id="cb7-11"><a href="#cb7-11"></a><span class="co">#&gt; [1] C/en_GB.UTF-8/en_GB.UTF-8/C/en_GB.UTF-8/en_GB.UTF-8</span></span>
<span id="cb7-12"><a href="#cb7-12"></a><span class="co">#&gt; </span></span>
<span id="cb7-13"><a href="#cb7-13"></a><span class="co">#&gt; attached base packages:</span></span>
<span id="cb7-14"><a href="#cb7-14"></a><span class="co">#&gt; [1] parallel  splines   stats     graphics  grDevices utils     datasets </span></span>
<span id="cb7-15"><a href="#cb7-15"></a><span class="co">#&gt; [8] methods   base     </span></span>
<span id="cb7-16"><a href="#cb7-16"></a><span class="co">#&gt; </span></span>
<span id="cb7-17"><a href="#cb7-17"></a><span class="co">#&gt; other attached packages:</span></span>
<span id="cb7-18"><a href="#cb7-18"></a><span class="co">#&gt; [1] chicane_0.1.2     data.table_1.12.8 gamlss.tr_5.1-0   gamlss_5.1-6     </span></span>
<span id="cb7-19"><a href="#cb7-19"></a><span class="co">#&gt; [5] nlme_3.1-148      gamlss.data_5.1-4 gamlss.dist_5.1-6 MASS_7.3-51.6    </span></span>
<span id="cb7-20"><a href="#cb7-20"></a><span class="co">#&gt; </span></span>
<span id="cb7-21"><a href="#cb7-21"></a><span class="co">#&gt; loaded via a namespace (and not attached):</span></span>
<span id="cb7-22"><a href="#cb7-22"></a><span class="co">#&gt;  [1] Rcpp_1.0.4.6         compiler_3.6.1       formatR_1.7         </span></span>
<span id="cb7-23"><a href="#cb7-23"></a><span class="co">#&gt;  [4] bedr_1.0.7           futile.logger_1.4.3  iterators_1.0.12    </span></span>
<span id="cb7-24"><a href="#cb7-24"></a><span class="co">#&gt;  [7] R.methodsS3_1.8.0    futile.options_1.0.1 R.utils_2.9.2       </span></span>
<span id="cb7-25"><a href="#cb7-25"></a><span class="co">#&gt; [10] tools_3.6.1          testthat_2.3.2       digest_0.6.25       </span></span>
<span id="cb7-26"><a href="#cb7-26"></a><span class="co">#&gt; [13] evaluate_0.14        lattice_0.20-41      rlang_0.4.6         </span></span>
<span id="cb7-27"><a href="#cb7-27"></a><span class="co">#&gt; [16] Matrix_1.2-18        foreach_1.5.0        yaml_2.2.1          </span></span>
<span id="cb7-28"><a href="#cb7-28"></a><span class="co">#&gt; [19] VennDiagram_1.6.20   xfun_0.14            stringr_1.4.0       </span></span>
<span id="cb7-29"><a href="#cb7-29"></a><span class="co">#&gt; [22] knitr_1.28           grid_3.6.1           R6_2.4.1            </span></span>
<span id="cb7-30"><a href="#cb7-30"></a><span class="co">#&gt; [25] survival_3.1-12      rmarkdown_2.1        lambda.r_1.2.4      </span></span>
<span id="cb7-31"><a href="#cb7-31"></a><span class="co">#&gt; [28] magrittr_1.5         codetools_0.2-16     htmltools_0.4.0     </span></span>
<span id="cb7-32"><a href="#cb7-32"></a><span class="co">#&gt; [31] stringi_1.4.6        R.oo_1.23.0</span></span></code></pre></div>
</div>
<div id="acknowledgements" class="section level1">
<h1>Acknowledgements</h1>
<p>Development of CHiCANE was supported by <a href="http://breastcancernow.org">Breast Cancer Now</a>.</p>
</div>
<div id="references" class="section level1 unnumbered">
<h1>References</h1>
<div id="refs" class="references">
<div id="ref-baxter2018">
<p>Baxter, Joseph S, Olivia C Leavy, Nicola H Dryden, Sarah Maguire, Nichola Johnson, Vita Fedele, Nikiana Simigdala, et al. 2018. “Capture Hi-c Identifies Putative Target Genes at 33 Breast Cancer Risk Loci.” <em>Nature Communications</em> 9 (1): 1028.</p>
</div>
<div id="ref-cairns2016">
<p>Cairns, Jonathan, Paula Freire-Pritchett, Steven W Wingett, Csilla Várnai, Andrew Dimond, Vincent Plagnol, Daniel Zerbino, et al. 2016. “CHiCAGO: Robust Detection of Dna Looping Interactions in Capture Hi-c Data.” <em>Genome Biology</em> 17 (1): 127.</p>
</div>
<div id="ref-dryden2014">
<p>Dryden, Nicola H, Laura R Broome, Frank Dudbridge, Nichola Johnson, Nick Orr, Stefan Schoenfelder, Takashi Nagano, et al. 2014. “Unbiased Analysis of Potential Targets of Breast Cancer Susceptibility Loci by Capture Hi-c.” <em>Genome Research</em> 24 (11): 1854–68.</p>
</div>
<div id="ref-stasinopoulos2016">
<p>Stasinopoulos, Mikis, and Bob Rigby. 2016. <em>Gamlss.tr: Generating and Fitting Truncated “Gamlss.family” Distributions</em>. <a href="https://CRAN.R-project.org/package=gamlss.tr">https://CRAN.R-project.org/package=gamlss.tr</a>.</p>
</div>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
